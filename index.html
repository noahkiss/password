<!doctype html>
<html lang='en'>
  <head>
    <link rel='manifest' href='manifest.json'>
    <link rel='shortcut icon' href='assets/favicon.svg'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <title>Passphrase Generator</title>
  </head>
  <body>
    <main>
      <section class="flex justify-center p-4">
        <article class="bg-white rounded-lg shadow-lg p-6 max-w-lg w-full">
          <h2 class="text-2xl font-bold mb-4">Generate Password</h2>
          <div id="password-strength" class="mb-6">
            <input id="input" type="range" min="48" max="128" step="8" value="72"
                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                   oninput="updateSlider(parseInt(value)); generatePassword();">
            <label for="input" class="flex items-center mt-2 text-gray-600">
              <span>Password strength: </span>
              <output id="output" for="value" class="mx-1">72</output>
              <span> bits</span>
            </label>
          </div>
          <button class="pass-button w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded mb-4"
                  value="Generate" onclick="generatePassword();">Generate</button>
          <div id="alt-pass" class="password break-all p-4 bg-gray-100 rounded mb-4 min-h-[40px]"></div>
          <div id="alt-overlay" class="statistics bg-gray-50 rounded p-4">
            <dl class="grid grid-cols-2 gap-2">
              <dt class="text-gray-600">Length:</dt>
              <dd id="alt-length" class="text-right"></dd>
              <dt class="text-gray-600">Security:</dt>
              <dd id="alt-entropy" class="text-right"></dd>
              <dt class="text-gray-600">Set size:</dt>
              <dd id="alt-set-size" class="text-right"></dd>
            </dl>
          </div>
        </article>
      </section>
    </main>

    <script>
      /**
       * An input slider ranging from values 48 to 128 stepping every 8.
       * @param {number} n - An 8-bit value
       */
      function updateSlider(n) {
        const passClass = document.querySelector('.password')

        passClass.classList.remove('p48')
        passClass.classList.remove('p56')
        passClass.classList.remove('p64')
        passClass.classList.remove('p72')

        if (n === 48) {
          passClass.classList.add('p48')
        } else if (n === 56) {
          passClass.classList.add('p56')
        } else if (n === 64) {
          passClass.classList.add('p64')
        } else if (n >= 72) {
          passClass.classList.add('p72')
        }

        document.querySelector('#output').value = n
        localStorage.setItem('security', n)
      }

      /**
       * Remove all duplicates from an array. Case-sensitive.
       * @param {Array} list - An array of strings or numbers which might contain duplicates.
       * @return {Array} - The array with duplicates removed.
       */
      function uniquesOnly(list) {
        return [...new Set(list)] // enforce unique elements in array
      }

      /** Return selected entropy (56, 64, 72, 80, 88, 96, 104, 112, 120, or 128). */
      function getEntropy() {
        return parseInt(document.querySelector('#output').value)
      }

      /**
       * Add a checkbox to use entropy if its present in localStorage.entropy.
       * Mozilla will not store localStorage key values to disk under the file:// protocol.
       * See https://bugzilla.mozilla.org/show_bug.cgi?id=507361 for more information.
       */
      function toggleEntropyVisibility() {
        const classes = document.getElementsByClassName('use-entropy')

        if (localStorage.hasOwnProperty('entropy')) {
          if (JSON.parse(localStorage.entropy).length > 0) {
            for (let i = 0; i < classes.length; i++) {
              classes[i].style.visibility = 'visible'
              classes[i].children[2].innerText = JSON.parse(localStorage.entropy).length
            }
          } else {
            for (let i = 0; i < classes.length; i++) {
              classes[i].style.visibility = 'hidden'
            }
          }
        }
      }

      /**
       * A cryptographically secure uniform random number generator.
       * @param {number} count - The max number a random number can be.
       * @param {boolean} useEntropy - Whether or not to use the data in localStorage.entropy.
       * @return {number} - Uniform random number.
       */
      function secRand(count, useEntropy) {
        let num = 0
        const min = 2 ** 32 % count
        const rand = new Uint32Array(1)

        if (useEntropy) {
          const entropy = JSON.parse(localStorage.entropy)

          if (entropy.length > 0) {
            num = entropy[0]
            entropy.shift()
            localStorage.entropy = JSON.stringify(entropy)
          }
        }

        do {
          num ^= crypto.getRandomValues(rand)[0]
        } while (num < min)

        toggleEntropyVisibility()

        return num % count
      }

      /**
       * The critical password generation function. Generates a password from a given set of data.
       * @param {number} len - How many characters/words to pick.
       * @param {string|Array} set - The data set to pick from.
       * @param {boolean} spaces - Whether to space-separate the password.
       * @return {string} - The generated password.
       */
      function generatePass(len, set, spaces) {
        let pass = ''
        let passArr = ''

        if (typeof set === 'string') {
          passArr = set.split('')
        } else {
          passArr = set
        }

        for (let i = len; i > 0; i--) {
          if (spaces) {
            pass += passArr[secRand(set.length, false)]
            pass += ' '
          } else {
            pass += passArr[secRand(set.length, false)]
          }
        }

        return pass
      }

      const altProps = {
        "passId": document.getElementById('alt-pass'),
        "passLength": document.getElementById('alt-length'),
        "passEntropy": document.getElementById('alt-entropy'),
        "setSize": document.getElementById('alt-set-size'),
      }

      function generatePassword() {
        let pass = ''
        let wordList = []

        wordList = wordList.concat(alternatePgp)
        wordList = wordList.concat(alternatePokerware)
        wordList = wordList.concat(alternateVAN[0])
        wordList = wordList.concat(alternateVAN[1])
        wordList = wordList.concat(alternateVAN[2])
        wordList = wordList.concat(alternateWordle)
        wordList = wordList.concat(bitcoinEN)
        wordList = wordList.concat(dicewareNLP[0])
        wordList = wordList.concat(dicewareNLP[1])
        wordList = wordList.concat(effDistant)
        wordList = wordList.concat(effGameOfThrones)
        wordList = wordList.concat(effHarryPotter)
        wordList = wordList.concat(effLong)
        wordList = wordList.concat(effShort)
        wordList = wordList.concat(effStarTrek)
        wordList = wordList.concat(effStarWars)
        wordList = wordList.concat(moneroEN)
        wordList = wordList.map(v => v.toLowerCase())

        wordList = uniquesOnly(wordList)

        const entropy = getEntropy()
        const len = Math.ceil(entropy / Math.log2(wordList.length))

        pass = generatePass(len, wordList, true).trim()
        pass = pass.replace(/ /g, '-')
        altProps.passId.classList.remove('acronym')
        altProps.passId.classList.remove('colors')
        altProps.passEntropy.innerText = Math.floor(len * Math.log2(wordList.length)) + ' bits'
        altProps.passId.innerText = pass
        altProps.passLength.innerText = [...pass].length + ' characters'
        altProps.setSize.innerText = wordList.length.toLocaleString() + ' words'
      }
    </script>

    <script src='js/tailwind.js'></script>

    <script src='lists/alternatePgp.js'></script>
    <script src='lists/alternatePokerware.js'></script>
    <script src='lists/alternateVAN.js'></script>
    <script src='lists/alternateWordle.js'></script>
    <script src='lists/bitcoinEN.js'></script>
    <script src='lists/dicewareNLP.js'></script>
    <script src='lists/effDistant.js'></script>
    <script src='lists/effGameOfThrones.js'></script>
    <script src='lists/effHarryPotter.js'></script>
    <script src='lists/effLong.js'></script>
    <script src='lists/effShort.js'></script>
    <script src='lists/effStarTrek.js'></script>
    <script src='lists/effStarWars.js'></script>
    <script src='lists/moneroEN.js'></script>

    <script>
      "use strict"

      document.body.lang = navigator.language

      window.onload = function() {
        generatePassword()
      }
    </script>
  </body>
</html>
